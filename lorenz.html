<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Lorenz Attractor — Fast Neon Chaos Lab</title>
  <style>
    :root{
      --bg:#070912;
      --panel: rgba(15,18,28,.72);
      --panel2: rgba(15,18,28,.50);
      --stroke: rgba(255,255,255,.12);
      --text: rgba(255,255,255,.92);
      --muted: rgba(255,255,255,.66);
      --accent: #7cf7ff;
      --warn: #ff7c9c;
      --good: #9dff7c;
    }
    html,body{height:100%; margin:0; background:var(--bg); overflow:hidden; font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;}
    canvas{display:block; width:100vw; height:100vh;}
    #ui{
      position: fixed; top: 12px; left: 12px; right: 12px;
      display:flex; gap:12px; align-items:flex-start; pointer-events:none;
      z-index:10;
    }
    .panel{
      pointer-events:auto;
      background: var(--panel);
      border: 1px solid var(--stroke);
      border-radius: 14px;
      box-shadow: 0 10px 30px rgba(0,0,0,.35);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      color: var(--text);
      overflow:hidden;
    }
    .panel header{
      padding: 10px 12px;
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,0));
      border-bottom: 1px solid var(--stroke);
    }
    .title{font-weight:800; letter-spacing:.2px; font-size:13px; display:flex; align-items:center; gap:8px;}
    .chip{
      font-size:11px; color:var(--muted);
      border:1px solid var(--stroke);
      background: rgba(255,255,255,.04);
      padding: 2px 8px; border-radius: 999px;
    }
    .content{padding: 10px 12px; display:grid; gap:10px;}
    .row{display:grid; grid-template-columns: 1fr auto; gap:10px; align-items:center;}
    label{font-size:11px; color:var(--muted); user-select:none;}
    input[type="range"]{width: 210px; accent-color: var(--accent);}
    select{
      width: 220px; padding:6px 8px; border-radius:10px;
      border:1px solid var(--stroke);
      background: #ffffff; color: #000000;
      -webkit-appearance: none; -moz-appearance: none; appearance: none;
    }
    /* Ensure dropdown and option contrast: black text on white background */
    select option { color: #000000; background: #ffffff; }
    select::-ms-expand{ display: none; }
    .btns{display:flex; gap:8px; flex-wrap:wrap;}
    button{
      cursor:pointer;
      border-radius: 12px;
      border: 1px solid var(--stroke);
      background: rgba(255,255,255,.05);
      color: var(--text);
      padding: 7px 10px;
      font-weight: 750;
      font-size: 12px;
      transition: transform .06s ease, background .12s ease;
    }
    button:hover{background: rgba(255,255,255,.09);}
    button:active{transform: translateY(1px);}
    .wide{min-width: 98px;}
    .danger{border-color: rgba(255,124,156,.35); background: rgba(255,124,156,.10);}
    .good{border-color: rgba(157,255,124,.28); background: rgba(157,255,124,.10);}
    .toggleRow{display:flex; gap:10px; align-items:center; justify-content:space-between;}
    .toggle{display:flex; align-items:center; gap:8px; user-select:none; font-size:11px; color:var(--muted);}
    .toggle input{accent-color: var(--accent);}
    .kv{font-size:11px; color:var(--muted); display:flex; justify-content:space-between; gap:10px;}
    .kv b{color:var(--text);}
    .hint{
      font-size:11px; color:var(--muted);
      line-height:1.25;
      padding: 10px 12px;
      background: var(--panel2);
      border-top:1px solid var(--stroke);
    }

    /* Hide panels but keep restore strip */
    #ui.hidden #leftCol,
    #ui.hidden #rightCol { display:none; }
    #showBar{
      pointer-events:auto;
      display:none;
      background: rgba(15,18,28,.72);
      border: 1px solid rgba(255,255,255,.12);
      border-radius: 14px;
      padding: 8px 10px;
      color: rgba(255,255,255,.9);
      font-size: 12px;
      user-select:none;
      cursor:pointer;
    }
    #ui.hidden #showBar{ display:inline-block; }

    #leftCol{width: 380px; max-width: calc(100vw - 24px);}
    #rightCol{margin-left:auto; width: 340px; max-width: calc(100vw - 24px);}

    @media (max-width: 900px){
      #ui{flex-direction:column;}
      #rightCol{margin-left:0; width: 380px;}
      input[type="range"]{width: 190px;}
    }
  </style>
</head>
<body>
<canvas id="c"></canvas>

<div id="ui">
  <div id="showBar">Show toolbars</div>

  <div id="leftCol" class="panel">
    <header>
      <div class="title">Lorenz Attractor <span class="chip">fast + neon</span></div>
      <div class="btns">
        <button id="pauseBtn" class="wide">Pause</button>
        <button id="resetBtn" class="wide danger">Reset</button>
        <button id="burstBtn" class="wide good">Burst</button>
      </div>
    </header>
    <div class="content">
      <div class="row">
        <label>Simulation speed</label>
        <input id="speed" type="range" min="0" max="300" value="120">
      </div>

      <div class="row">
        <label>dt</label>
        <input id="dt" type="range" min="1" max="60" value="12">
      </div>

      <div class="row">
        <label>Particles</label>
        <input id="n" type="range" min="1" max="20000" value="8000">
      </div>

      <div class="row">
        <label>Sigma (σ)</label>
        <input id="sigma" type="range" min="0" max="300" value="100">
      </div>

      <div class="row">
        <label>Rho (ρ)</label>
        <input id="rho" type="range" min="0" max="600" value="280">
      </div>

      <div class="row">
        <label>Beta (β)</label>
        <input id="beta" type="range" min="0" max="200" value="27">
      </div>

      <div class="toggleRow">
        <div class="toggle"><span>Stabilize (reseed if NaN)</span> <input id="stabilize" type="checkbox" checked></div>
        <div class="toggle"><span>Hide toolbars</span> <input id="hideUI" type="checkbox"></div>
      </div>

      <div class="btns">
        <button id="pngBtn" class="wide">PNG</button>
        <button id="seedBtn" class="wide">Reseed</button>
      </div>
    </div>
    <div class="hint">
      <div class="kv"><span>Controls</span><b>Drag = rotate • Wheel = zoom</b></div>
      <div>Space = pause • R = reset • B = burst • H = hide UI</div>
    </div>
  </div>

  <div id="rightCol" class="panel">
    <header>
      <div class="title">Look <span class="chip">glow</span></div>
      <div class="btns">
        <button id="invertBtn" class="wide">Invert</button>
        <button id="fitBtn" class="wide">Fit</button>
      </div>
    </header>
    <div class="content">
      <div class="row">
        <label>Point size</label>
        <input id="pt" type="range" min="1" max="12" value="2">
      </div>

      <div class="row">
        <label>Glow</label>
        <input id="glow" type="range" min="0" max="200" value="80">
      </div>

      <div class="row">
        <label>Fade (trail persistence)</label>
        <input id="fade" type="range" min="0" max="100" value="18">
      </div>

      <div class="row">
        <label>Color mode</label>
        <select id="color">
          <option value="speed" selected>Speed (neon)</option>
          <option value="z">Z height</option>
          <option value="age">Age</option>
          <option value="mono">Monochrome</option>
        </select>
      </div>

      <div class="toggleRow">
        <div class="toggle"><span>Additive</span> <input id="add" type="checkbox" checked></div>
        <div class="toggle"><span>Motion blur</span> <input id="blur" type="checkbox" checked></div>
      </div>

      <div class="kv"><span>FPS</span><b id="fps">—</b></div>
      <div class="kv"><span>Particles</span><b id="live">—</b></div>
      <div class="kv"><span>σ ρ β</span><b id="srb">—</b></div>
    </div>
    <div class="hint">
      Lorenz: x' = σ(y−x), y' = x(ρ−z)−y, z' = xy − βz.
    </div>
  </div>
</div>

<script>
(() => {
  // Canvas (safe fallback)
  const canvas = document.getElementById('c');
  let ctx = canvas.getContext('2d', { alpha:false, desynchronized:true });
  if (!ctx) ctx = canvas.getContext('2d', { alpha:false });
  if (!ctx) ctx = canvas.getContext('2d');
  if (!ctx){ alert("No Canvas 2D context available."); throw new Error("No canvas 2D context"); }

  let W=0,H=0,DPR=1;
  function resize(){
    DPR = Math.max(1, Math.min(2, window.devicePixelRatio || 1));
    W = window.innerWidth|0;
    H = window.innerHeight|0;
    canvas.width  = (W*DPR)|0;
    canvas.height = (H*DPR)|0;
    canvas.style.width = W+"px";
    canvas.style.height = H+"px";
    ctx.setTransform(DPR,0,0,DPR,0,0);
  }
  window.addEventListener('resize', resize, { passive:true });
  resize();

  const UI = id => document.getElementById(id);
  const el = {
    ui: UI('ui'),
    showBar: UI('showBar'),
    pauseBtn: UI('pauseBtn'),
    resetBtn: UI('resetBtn'),
    burstBtn: UI('burstBtn'),
    pngBtn: UI('pngBtn'),
    seedBtn: UI('seedBtn'),
    invertBtn: UI('invertBtn'),
    fitBtn: UI('fitBtn'),

    speed: UI('speed'),
    dt: UI('dt'),
    n: UI('n'),
    sigma: UI('sigma'),
    rho: UI('rho'),
    beta: UI('beta'),
    stabilize: UI('stabilize'),
    hideUI: UI('hideUI'),

    pt: UI('pt'),
    glow: UI('glow'),
    fade: UI('fade'),
    color: UI('color'),
    add: UI('add'),
    blur: UI('blur'),

    fps: UI('fps'),
    live: UI('live'),
    srb: UI('srb'),
  };

  const params = {
    paused:false,
    speed: 1.20,
    dt: 0.012,

    n: 8000,

    sigma: 10,
    rho: 28,
    beta: 8/3,

    stabilize: true,

    pt: 2,
    glow: 0.80,
    fade: 0.18,
    color: 'speed',
    additive: true,
    motionBlur: true,
    invert: false,
  };

  function syncFromUI(){
    params.speed = (+el.speed.value)/100;
    params.dt    = (+el.dt.value)/1000;
    params.n     = (+el.n.value)|0;

    params.sigma = (+el.sigma.value)/10;
    params.rho   = (+el.rho.value)/10;
    params.beta  = (+el.beta.value)/10;

    params.stabilize = el.stabilize.checked;

    params.pt    = (+el.pt.value)|0;
    params.glow  = (+el.glow.value)/100;
    params.fade  = (+el.fade.value)/100;
    params.color = el.color.value;
    params.additive = el.add.checked;
    params.motionBlur = el.blur.checked;

    if (el.ui) el.ui.classList.toggle('hidden', el.hideUI.checked);
    el.srb.textContent = `${params.sigma.toFixed(2)}  ${params.rho.toFixed(2)}  ${params.beta.toFixed(2)}`;
  }

  [
    'speed','dt','n','sigma','rho','beta','stabilize','hideUI',
    'pt','glow','fade','color','add','blur'
  ].forEach(id => {
    const node = UI(id);
    if (!node) return;
    node.addEventListener('input', syncFromUI, { passive:true });
    node.addEventListener('change', syncFromUI, { passive:true });
  });
  syncFromUI();

  el.showBar.addEventListener('click', () => {
    el.hideUI.checked = false;
    syncFromUI();
  });

  // Camera
  const cam = { rotX: 0.95, rotY: -0.65, dist: 55, panX: 0, panY: 0 };
  function fitCamera(){ cam.rotX=0.95; cam.rotY=-0.65; cam.dist=55; cam.panX=0; cam.panY=0; }
  fitCamera();

  const mouse = {down:false, x:0, y:0, btn:0};
  window.addEventListener('mousedown', (e)=>{ mouse.down=true; mouse.x=e.clientX; mouse.y=e.clientY; mouse.btn=e.button; }, { passive:true });
  window.addEventListener('mouseup', ()=>{ mouse.down=false; }, { passive:true });
  window.addEventListener('mousemove', (e)=>{
    if (!mouse.down) return;
    const dx = e.clientX - mouse.x;
    const dy = e.clientY - mouse.y;
    mouse.x = e.clientX; mouse.y = e.clientY;

    if (mouse.btn === 0){
      cam.rotY += dx * 0.006;
      cam.rotX += dy * 0.006;
      cam.rotX = Math.max(-1.5, Math.min(1.5, cam.rotX));
    } else {
      cam.panX += dx;
      cam.panY += dy;
    }
  }, { passive:true });

  window.addEventListener('wheel', (e)=>{
    e.preventDefault();
    const s = Math.sign(e.deltaY);
    cam.dist *= (s > 0 ? 1.08 : 0.92);
    cam.dist = Math.max(12, Math.min(180, cam.dist));
  }, { passive:false });

  // Particles
  let N = 0;
  let x = new Float32Array(0), y = new Float32Array(0), z = new Float32Array(0);
  let age = new Uint16Array(0);

  function alloc(){
    N = Math.max(1, Math.min(20000, params.n|0));
    x = new Float32Array(N);
    y = new Float32Array(N);
    z = new Float32Array(N);
    age = new Uint16Array(N);
    reseed();
    el.live.textContent = String(N);
  }

  function reseed(){
    for (let i=0;i<N;i++){
      x[i] = (Math.random()*2-1) * 0.6;
      y[i] = (Math.random()*2-1) * 0.6;
      z[i] = 15 + (Math.random()*2-1) * 0.8;
      age[i] = (Math.random()*120)|0;
    }
    // hard clear background so you see fresh
    ctx.globalCompositeOperation = 'source-over';
    ctx.fillStyle = params.invert ? 'rgba(255,255,255,1)' : 'rgba(7,9,18,1)';
    ctx.fillRect(0,0,W,H);
  }

  function ensureAlloc(){
    const want = Math.max(1, Math.min(20000, params.n|0));
    if (want !== N) alloc();
  }

  alloc();

  // Lorenz RK4
  function deriv(xx,yy,zz, s,r,b){
    return [ s*(yy-xx), xx*(r-zz)-yy, xx*yy - b*zz ];
  }
  function rk4Step(i, dt, s,r,b){
    const x0=x[i], y0=y[i], z0=z[i];
    const k1=deriv(x0,y0,z0,s,r,b);

    const x1=x0+0.5*dt*k1[0], y1=y0+0.5*dt*k1[1], z1=z0+0.5*dt*k1[2];
    const k2=deriv(x1,y1,z1,s,r,b);

    const x2=x0+0.5*dt*k2[0], y2=y0+0.5*dt*k2[1], z2=z0+0.5*dt*k2[2];
    const k3=deriv(x2,y2,z2,s,r,b);

    const x3=x0+dt*k3[0], y3=y0+dt*k3[1], z3=z0+dt*k3[2];
    const k4=deriv(x3,y3,z3,s,r,b);

    x[i]=x0+(dt/6)*(k1[0]+2*k2[0]+2*k3[0]+k4[0]);
    y[i]=y0+(dt/6)*(k1[1]+2*k2[1]+2*k3[1]+k4[1]);
    z[i]=z0+(dt/6)*(k1[2]+2*k2[2]+2*k3[2]+k4[2]);
  }

  function projectPoint(xx,yy,zz){
    const cy=Math.cos(cam.rotY), sy=Math.sin(cam.rotY);
    const cx=Math.cos(cam.rotX), sx=Math.sin(cam.rotX);

    // rotY
    let x1 =  xx*cy + zz*sy;
    let z1 = -xx*sy + zz*cy;
    // rotX
    let y2 =  yy*cx - z1*sx;
    let z2 =  yy*sx + z1*cx;

    const scale = cam.dist / (cam.dist + z2*0.25 + 1e-6);
    const px = x1 * scale;
    const py = y2 * scale;

    return [ W*0.5 + cam.panX + px*10, H*0.5 + cam.panY + py*10, z2 ];
  }

  // Color
  function hsvToRgb(h,s,v){
    const i=(h*6)|0;
    const f=h*6-i;
    const p=v*(1-s), q=v*(1-f*s), t=v*(1-(1-f)*s);
    let r,g,b;
    switch(i%6){
      case 0: r=v; g=t; b=p; break;
      case 1: r=q; g=v; b=p; break;
      case 2: r=p; g=v; b=t; break;
      case 3: r=p; g=q; b=v; break;
      case 4: r=t; g=p; b=v; break;
      case 5: r=v; g=p; b=q; break;
    }
    return [(r*255)|0,(g*255)|0,(b*255)|0];
  }

  function colorFor(i, dx,dy,dz){
    if (params.color === 'mono'){
      return params.invert ? 'rgba(0,0,0,0.9)' : 'rgba(124,247,255,0.9)';
    }
    if (params.color === 'age'){
      const t = Math.min(1, age[i] / 220);
      const h = 0.56 - t*0.28;
      const [r,g,b] = hsvToRgb((h+1)%1, 0.95, 1.0);
      return `rgba(${r},${g},${b},0.9)`;
    }
    if (params.color === 'z'){
      const t = Math.min(1, Math.max(0, (z[i]) / 50));
      const h = 0.62 - t*0.35;
      const [r,g,b] = hsvToRgb((h+1)%1, 0.95, 1.0);
      return `rgba(${r},${g},${b},0.9)`;
    }
    // speed
    const sp = Math.min(1, Math.sqrt(dx*dx+dy*dy+dz*dz)/40);
    const h = 0.55 - sp*0.22;
    const [r,g,b] = hsvToRgb((h+1)%1, 0.95, 1.0);
    return `rgba(${r},${g},${b},0.9)`;
  }

  function clearBackground(){
    ctx.globalCompositeOperation = 'source-over';
    if (params.motionBlur){
      const a = 0.06 + (1-params.fade)*0.24;
      ctx.fillStyle = params.invert ? `rgba(255,255,255,${a})` : `rgba(7,9,18,${a})`;
    } else {
      ctx.fillStyle = params.invert ? 'rgba(255,255,255,1)' : 'rgba(7,9,18,1)';
    }
    ctx.fillRect(0,0,W,H);
  }

  function draw(){
    clearBackground();
    ctx.globalCompositeOperation = params.additive ? 'lighter' : 'source-over';

    const g = Math.max(0, Math.min(2, params.glow));
    const pt = params.pt;

    // glow pass
    if (g > 0.001){
      ctx.globalAlpha = 0.20 + 0.25*g;
      const sz = pt * (1.6 + g*1.4);
      for (let i=0;i<N;i++){
        const d = deriv(x[i],y[i],z[i], params.sigma,params.rho,params.beta);
        const p = projectPoint(x[i],y[i],z[i]);
        ctx.fillStyle = colorFor(i,d[0],d[1],d[2]).replace('0.9', String(0.18 + 0.20*g));
        ctx.fillRect(p[0], p[1], sz, sz);
      }
      ctx.globalAlpha = 1.0;
    }

    // main pass
    ctx.globalAlpha = 0.85;
    for (let i=0;i<N;i++){
      const d = deriv(x[i],y[i],z[i], params.sigma,params.rho,params.beta);
      const p = projectPoint(x[i],y[i],z[i]);
      ctx.fillStyle = colorFor(i,d[0],d[1],d[2]);
      ctx.fillRect(p[0], p[1], pt, pt);
    }
    ctx.globalAlpha = 1.0;
  }

  function stabilize(){
    if (!params.stabilize) return;
    for (let i=0;i<N;i++){
      if (!isFinite(x[i]) || !isFinite(y[i]) || !isFinite(z[i]) || Math.abs(x[i])>300 || Math.abs(y[i])>300 || z[i]<-80 || z[i]>500){
        x[i] = (Math.random()*2-1)*0.6;
        y[i] = (Math.random()*2-1)*0.6;
        z[i] = 15 + (Math.random()*2-1)*0.8;
        age[i] = 0;
      }
    }
  }

  // Buttons
  el.pauseBtn.addEventListener('click', ()=>{
    params.paused = !params.paused;
    el.pauseBtn.textContent = params.paused ? 'Resume' : 'Pause';
  });
  el.resetBtn.addEventListener('click', ()=>{ reseed(); fitCamera(); });
  el.seedBtn.addEventListener('click', ()=> reseed());
  el.fitBtn.addEventListener('click', ()=> fitCamera());
  el.invertBtn.addEventListener('click', ()=> { params.invert=!params.invert; });
  el.pngBtn.addEventListener('click', ()=>{
    const a = document.createElement('a');
    a.download = 'lorenz.png';
    a.href = canvas.toDataURL('image/png');
    a.click();
  });
  el.burstBtn.addEventListener('click', ()=>{
    // tiny param kick + particle jitter
    params.rho = Math.max(0.01, params.rho + (Math.random()*2-1)*2.0);
    params.sigma = Math.max(0.01, params.sigma + (Math.random()*2-1)*0.5);
    params.beta = Math.max(0.01, params.beta + (Math.random()*2-1)*0.2);

    el.rho.value = Math.max(0, Math.min(600, Math.round(params.rho*10)));
    el.sigma.value = Math.max(0, Math.min(300, Math.round(params.sigma*10)));
    el.beta.value = Math.max(0, Math.min(200, Math.round(params.beta*10)));
    syncFromUI();

    for (let i=0;i<N;i++){
      x[i] += (Math.random()*2-1)*0.03;
      y[i] += (Math.random()*2-1)*0.03;
      z[i] += (Math.random()*2-1)*0.03;
      age[i] = 0;
    }
  });

  // Keyboard
  window.addEventListener('keydown', (e)=>{
    const k = e.key.toLowerCase();
    if (k===' '){ e.preventDefault(); el.pauseBtn.click(); }
    else if (k==='r'){ el.resetBtn.click(); }
    else if (k==='b'){ el.burstBtn.click(); }
    else if (k==='h'){ el.hideUI.checked = !el.hideUI.checked; syncFromUI(); }
  });

  // Main loop
  let last = performance.now();
  let fpsAcc=0,fpsCnt=0,fpsLast=performance.now();

  function loop(now){
    const rawDt = Math.min(0.05, Math.max(0.001, (now-last)/1000));
    last = now;

    ensureAlloc();

    if (!params.paused){
      const simDt = params.dt * params.speed;
      const sub = (params.speed > 1.5 || simDt > 0.02) ? 2 : 1;
      const dt = simDt / sub;

      const s=params.sigma, r=params.rho, b=params.beta;
      for (let step=0; step<sub; step++){
        for (let i=0;i<N;i++){
          rk4Step(i, dt, s,r,b);
          age[i] = (age[i] + 1) & 0xffff;
        }
        stabilize();
      }
    }

    draw();

    fpsAcc += 1/rawDt; fpsCnt++;
    if (now - fpsLast > 300){
      el.fps.textContent = (fpsAcc/fpsCnt).toFixed(0);
      fpsAcc=0; fpsCnt=0; fpsLast=now;
      el.live.textContent = String(N);
      el.srb.textContent = `${params.sigma.toFixed(2)}  ${params.rho.toFixed(2)}  ${params.beta.toFixed(2)}`;
    }

    requestAnimationFrame(loop);
  }
  requestAnimationFrame(loop);

})();
</script>
</body>
</html>
